<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>BAEKSAN ì´ë¯¸ì§€ ì—…ë¡œë”</title>

  <!-- ëª¨ë°”ì¼ ì›¹ì•± ë©”íƒ€ -->
  <meta name="theme-color" content="#111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#0b0b0c; --fg:#f2f3f5; --muted:#a0a4ab; --line:#1f2126;
      --brand:#6aa1ff; --ok:#34c759; --err:#ff453a; --warn:#ffcc00;
    }
    *{box-sizing:border-box}
    body{background:var(--bg); color:var(--fg); font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0}
    .wrap{max-width:720px; padding:16px 16px 80px; margin:0 auto}
    h1{font-size:20px; margin:12px 0 16px}
    .card{background:#121316; border:1px solid var(--line); border-radius:16px; padding:14px}
    .row{margin-bottom:12px}
    label{display:block; font-weight:700; margin:0 0 6px 2px; font-size:14px}
    input,select,button{
      font-size:16px; padding:12px 12px; border:1px solid var(--line); border-radius:12px; width:100%;
      background:#0f1013; color:var(--fg); outline:none;
    }
    input::placeholder{color:#7b8088}
    button{cursor:pointer; background:var(--brand); border:none; font-weight:700}
    button:disabled{opacity:.6; cursor:not-allowed}
    .muted{color:var(--muted); font-size:12px}
    .toolbar{display:flex; gap:10px}
    .toolbar > *{flex:1}
    .progress{height:10px; background:#191b21; border:1px solid var(--line); border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,#5e8bff,#8ec5ff)}
    .list{margin-top:12px}
    .item{display:flex; align-items:center; gap:10px; padding:8px 6px; border-bottom:1px dashed var(--line)}
    .thumb{width:48px; height:48px; border-radius:8px; background:#0d0e11; flex:0 0 auto; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid var(--line)}
    .thumb img{width:100%; height:100%; object-fit:cover}
    .meta{flex:1; min-width:0}
    .meta .name{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:14px}
    .meta .sub{font-size:12px; color:var(--muted)}
    .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--line)}
    .pill.ok{border-color:rgba(52,199,89,.4); color:var(--ok)}
    .pill.err{border-color:rgba(255,69,58,.4); color:var(--err)}
    .pill.up{border-color:rgba(106,161,255,.5); color:#a7c5ff}
    .footer{position:fixed; inset:auto 0 0 0; background:rgba(18,19,22,.9); border-top:1px solid var(--line); padding:8px 12px}
    .sum{display:flex; gap:8px; justify-content:space-between; align-items:center}
    .sum small{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BAEKSAN ì´ë¯¸ì§€ ì—…ë¡œë”</h1>

    <div class="card">
      <div class="row">
        <label for="pin">ê³µìš© PIN</label>
        <input id="pin" inputmode="numeric" pattern="\d*" placeholder="ë³‘ì› ê³µìš© PIN ì½”ë“œ" autocomplete="one-time-code" />
      </div>

      <div class="row">
        <label for="vet">ìˆ˜ì˜ì‚¬</label>
        <select id="vet">
          <option value="">ì„ íƒ</option>
          <!-- ã„±ã„´ã„· ìˆœ -->
          <option>ê¹€ì§€í˜„</option><option>ê¹€í˜•ì¤€</option>
          <option>ë¬¸ì •í˜„</option><option>ë¯¼ê¸ˆì£¼</option>
          <option>ë°•ì†Œë¯¼</option><option>ì†¡ì• ë¼</option>
          <option>ìœ ìˆ˜ë¯¼</option><option>ì´ì€ì§€</option><option>ì´ì†Œë¯¼</option>
          <option>ì •ì†Œì—°</option><option>ì¡°ë¬¸ì£¼</option><option>í•œì•„ë¦„</option>
        </select>
      </div>

      <div class="row">
        <label for="patient">í™˜ìì´ë¦„ *</label>
        <input id="patient" placeholder="ì˜ˆ: ëƒ¥ëƒ¥ì´" required />
      </div>

      <div class="row">
        <label for="owner">ë³´í˜¸ìì´ë¦„ (ì„ íƒ)</label>
        <input id="owner" placeholder="ì˜ˆ: ê¹€í˜¸ë‘" />
      </div>

      <div class="row">
        <label for="title">ì œëª© *</label>
        <input id="title" placeholder="ì˜ˆ: ê°„FNA" required />
        <div class="muted">íŒŒì¼ëª…: í™˜ì_ë³´í˜¸ì?_YYYYMMDD_ì œëª©.jpg (PNGëŠ” .png)</div>
      </div>

      <div class="row">
        <label for="file">ì‚¬ì§„ ì„ íƒ</label>
        <input id="file" type="file" accept="image/*" multiple />
        <div class="muted">ê¸´ ë³€ì´ 2500px ì´ˆê³¼ ì‹œ ìë™ ì¶•ì†Œ (jpg/png)</div>
      </div>

      <div class="toolbar row">
        <button id="uploadBtn" type="button">ğŸ“¤ ì—…ë¡œë“œ</button>
        <button id="clearBtn" type="button" style="background:#2b2d32">ğŸ§¹ ì´ˆê¸°í™”</button>
      </div>

      <div class="row">
        <div class="progress"><div id="overallBar" class="bar"></div></div>
        <div class="muted" id="overallText">ëŒ€ê¸° ì¤‘</div>
      </div>

      <div id="fileList" class="list"></div>
    </div>
  </div>

  <div class="footer">
    <div class="sum">
      <div>
        <strong id="sumOk" style="color:var(--ok)">0 ì„±ê³µ</strong> Â·
        <strong id="sumErr" style="color:var(--err)">0 ì‹¤íŒ¨</strong>
      </div>
      <small id="hint">ëª¨ë°”ì¼ ì „ìš© Â· ë„¤íŠ¸ì›Œí¬ í’ˆì§ˆì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”</small>
    </div>
  </div>

  <script>
    // ---------- ê³µí†µ ----------
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const fmtBytes = n => n<1024? `${n} B` : n<1024**2? `${(n/1024).toFixed(1)} KB` : `${(n/1024**2).toFixed(1)} MB`;
    const todayYYYYMMDD = () => { const d=new Date(), p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}`; };

    // ---------- ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ (Safari í˜¸í™˜, 2500 ì´ˆê³¼ì‹œì—ë§Œ) ----------
    async function resizeIfNeeded(file){
      const isPNG = /png$/i.test(file.type);
      const isJPG = /jpe?g$/i.test(file.type);
      if(!isPNG && !isJPG) return file;

      const url = URL.createObjectURL(file);
      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = ()=>resolve(i);
        i.onerror = reject;
        i.src = url;
      });
      URL.revokeObjectURL(url);

      const max = 2500;
      const long = Math.max(img.naturalWidth, img.naturalHeight);
      if(long <= max) return file;

      const scale = max / long;
      const w = Math.round(img.naturalWidth*scale), h = Math.round(img.naturalHeight*scale);
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d', {alpha:false});
      ctx.drawImage(img,0,0,w,h);

      const mime = isPNG ? 'image/png' : 'image/jpeg';
      const quality = isPNG ? undefined : 0.9;

      const blob = await new Promise((resolve,reject)=>{
        canvas.toBlob(b => b?resolve(b):reject(new Error('toBlob failed')), mime, quality);
      });

      const ext = isPNG?'.png':'.jpg';
      const base = file.name.replace(/\.[a-z0-9]+$/i,'');
      return new File([blob], base+ext, {type:mime,lastModified:Date.now()});
    }

    // ---------- ì—…ë¡œë“œ ë„ìš°ë¯¸ (XHRë¡œ ì§„í–‰ë¥  ë°›ê¸°) ----------
    function xhrUpload(formData, onProgress){
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/upload', true);
        xhr.responseType = 'json';
        xhr.upload.onprogress = e => { if(e.lengthComputable && onProgress) onProgress(e.loaded / e.total); };
        xhr.onload = () => {
          const res = xhr.response ?? (()=>{ try{ return JSON.parse(xhr.responseText) } catch{ return {ok:false,error:xhr.responseText||xhr.statusText}; }})();
          resolve({ status: xhr.status, body: res });
        };
        xhr.onerror = () => reject(new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'));
        xhr.send(formData);
      });
    }

    // ---------- UI ìš”ì†Œ ----------
    const overallBar = $('#overallBar');
    const overallText = $('#overallText');
    const list = $('#fileList');
    const btnUpload = $('#uploadBtn');
    const btnClear = $('#clearBtn');
    const sumOk = $('#sumOk'); const sumErr = $('#sumErr');

    function setDisabled(disabled){
      [btnUpload, $('#pin'), $('#vet'), $('#patient'), $('#owner'), $('#title'), $('#file')].forEach(el => el.disabled = disabled);
      btnUpload.textContent = disabled ? 'â³ ì—…ë¡œë“œ ì¤‘â€¦' : 'ğŸ“¤ ì—…ë¡œë“œ';
    }
    function setOverall(p, text){ overallBar.style.width = `${Math.max(0,Math.min(100, p*100))}%`; overallText.textContent = text; }

    function addItemPreview(file){
      const url = URL.createObjectURL(file);
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `
        <div class="thumb"><img src="${url}" alt=""></div>
        <div class="meta">
          <div class="name">${file.name}</div>
          <div class="sub">${fmtBytes(file.size)}</div>
          <div class="progress" style="margin-top:6px"><div class="bar"></div></div>
        </div>
        <div class="pill up">ëŒ€ê¸°</div>
      `;
      list.appendChild(el);
      const bar = el.querySelector('.bar');
      const pill = el.querySelector('.pill');
      return {
        setProgress: (r)=>{ bar.style.width = `${Math.round(r*100)}%`; },
        setStatus: (type, text)=>{
          pill.className = `pill ${type}`; pill.textContent = text;
        },
        cleanup: ()=> URL.revokeObjectURL(url)
      };
    }

    btnClear.addEventListener('click', ()=>{
      list.innerHTML=''; setOverall(0,'ëŒ€ê¸° ì¤‘'); sumOk.textContent='0 ì„±ê³µ'; sumErr.textContent='0 ì‹¤íŒ¨';
      $('#file').value='';
    });

    btnUpload.addEventListener('click', async ()=>{
      const pin=$('#pin').value.trim(), vet=$('#vet').value.trim(), patient=$('#patient').value.trim(), owner=$('#owner').value.trim(), title=$('#title').value.trim();
      const files = Array.from($('#file').files);

      if(!pin) return alert('ê³µìš© PINì„ ì…ë ¥í•˜ì„¸ìš”');
      if(!vet) return alert('ìˆ˜ì˜ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”');
      if(!patient) return alert('í™˜ìì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤');
      if(!title) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
      if(files.length===0) return alert('ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”');

      // UI ì¤€ë¹„
      list.innerHTML='';
      setDisabled(true);
      setOverall(0,'ì¤€ë¹„ ì¤‘â€¦');
      let ok=0, err=0;
      const ymd = todayYYYYMMDD();

      // ìˆœì°¨ ì—…ë¡œë“œ (ì•ˆì •ì„± â†‘, Dropbox rate-limit ì•ˆì „)
      for(let i=0;i<files.length;i++){
        const f = files[i];
        const ui = addItemPreview(f);
        ui.setStatus('up','ì¤€ë¹„ ì¤‘');

        // ë¦¬ì‚¬ì´ì¦ˆ
        let rf = f;
        try{
          const t0 = performance.now();
          rf = await resizeIfNeeded(f);
          const resized = rf !== f;
          ui.setStatus('up', resized ? 'ë¦¬ì‚¬ì´ì¦ˆ ì™„ë£Œ' : 'ì›ë³¸ ìœ ì§€');
        }catch(e){
          ui.setStatus('warn','ë¦¬ì‚¬ì´ì¦ˆ ì‹¤íŒ¨, ì›ë³¸');
        }

        // íŒíŠ¸ íŒŒì¼ëª…
        const hintName = `${patient}${owner?`_${owner}`:''}_${ymd}_${title}` + (rf.type==='image/png'?'.png':'.jpg');

        const form = new FormData();
        form.append('pin', pin);
        form.append('vet', vet);
        form.append('patient', patient);
        form.append('owner', owner);
        form.append('title', title);
        form.append('file', rf, hintName);

        // ì—…ë¡œë“œ
        ui.setStatus('up','ì—…ë¡œë“œ ì¤‘');
        try{
          const res = await xhrUpload(form, r=>{
            ui.setProgress(r);
            setOverall((i + r) / files.length, `ì „ì²´ ${i+1}/${files.length} ì—…ë¡œë“œ ì¤‘â€¦`);
          });
          if(res.body && res.body.ok){
            ok++; ui.setProgress(1); ui.setStatus('ok','ì™„ë£Œ');
          }else{
            err++; ui.setStatus('err', res.body?.error || 'ì‹¤íŒ¨');
          }
        }catch(e){
          err++; ui.setStatus('err', e.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
        }finally{
          ui.cleanup();
          sumOk.textContent = `${ok} ì„±ê³µ`;
          sumErr.textContent = `${err} ì‹¤íŒ¨`;
        }
      }

      setDisabled(false);
      setOverall(1, err===0 ? 'ëª¨ë“  ì—…ë¡œë“œ ì™„ë£Œ' : `ì™„ë£Œ(ì„±ê³µ ${ok}, ì‹¤íŒ¨ ${err})`);
      if(err===0){ $('#file').value=''; }
    });
  </script>
</body>
</html>
