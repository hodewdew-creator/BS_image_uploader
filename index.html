<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>백산 이미지 업로더</title>

  <!-- 모바일 웹앱 메타 -->
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#f7f8fa; --fg:#0b0c0f; --muted:#677085; --line:#e6e8ee;
      --brand:#2e6bff; --brand-weak:#e7efff; --ok:#0ea565; --err:#d72638; --warn:#b26a00;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    .wrap{
      max-width:720px; margin:0 auto; padding:10px 12px 12px;
      display:flex; flex-direction:column; min-height:100%;
      gap:10px;
    }

    /* 헤더 */
    .header{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .title{font-weight:800; font-size:18px; letter-spacing:-0.2px; white-space:nowrap}
    .pinbtn{
      border:1px solid var(--line); background:#fff; color:var(--fg);
      padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer;
    }
    .pinbtn.locked{background:var(--brand); color:#fff; border-color:var(--brand)}

    /* 카드 */
    .card{background:#fff; border:1px solid var(--line); border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:10px}

    label{display:block; font-size:12px; font-weight:800; color:#3a4150; margin:0 0 6px 2px}
    input,select,button{
      font-size:15px; padding:10px 12px; border:1px solid var(--line); border-radius:10px;
      background:#fff; color:var(--fg); outline:none; width:100%;
    }
    input::placeholder{color:#9aa3b2}
    button{cursor:pointer}
    button.primary{background:var(--brand); color:#fff; border:none; font-weight:800}
    button.secondary{background:#fff}

    /* 첫 줄: 수의사 버튼 + 보호자이름 한 줄 */
    .row-inline{display:flex; gap:8px; align-items:center}
    .owner{min-width:120px; flex:1}

    /* 수의사 버튼 그룹 (가로 스크롤 가능) */
    .vets{display:flex; gap:6px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:2px}
    .vet{flex:0 0 auto; padding:10px 12px; border:1px solid var(--line); background:#fff; border-radius:999px; font-size:14px; font-weight:700}
    .vet.active{background:var(--brand-weak); border-color:#cddcff; color:#1d3a8a}

    /* 두 번째 줄: 환자(짧게) + 제목(넓게) */
    .row-pt-title{display:flex; gap:8px}
    .patient{flex:0 0 90px} /* 한글 2~3자 고려한 폭 */
    .titleinput{flex:1}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}

    /* 파일 입력 + 툴바 */
    .toolbar{display:flex; gap:8px}
    .progress{height:8px; background:#f1f3f7; border:1px solid var(--line); border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,#8bb3ff,#2e6bff)}

    /* 리스트 (썸네일/진행) */
    .list{display:flex; flex-direction:column; gap:6px; max-height:32vh; overflow:auto}
    .item{display:flex; align-items:center; gap:8px; padding:6px; border:1px dashed var(--line); border-radius:10px}
    .thumb{width:44px; height:44px; border-radius:8px; background:#fafbfe; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid var(--line)}
    .thumb img{width:100%; height:100%; object-fit:cover}
    .meta{flex:1; min-width:0}
    .name{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:13px; font-weight:700}
    .sub{font-size:12px; color:var(--muted)}
    .pill{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--line)}
    .pill.ok{border-color:#c9f0dd; background:#effaf4; color:var(--ok)}
    .pill.err{border-color:#ffd2d6; background:#fff2f3; color:var(--err)}
    .pill.up{border-color:#d9e6ff; background:#f3f7ff; color:#2e6bff}
    .pill.warn{border-color:#ffe8b3; background:#fff7df; color:#a57400}

    .sumline{display:flex; gap:10px; justify-content:space-between; align-items:center; font-size:13px; color:#55607a}
    .sumline b{color:var(--fg)}

    /* 작은 화면에서 한 화면에 들어오도록 여백 최소화 */
    @media (max-width: 390px){
      .patient{flex-basis:80px}
      .pinbtn{padding:8px 10px}
    }

    /* 모달 (PIN) */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35)}
    .modal.show{display:flex}
    .sheet{background:#fff; width:min(420px,92vw); border-radius:16px; border:1px solid var(--line); padding:14px; display:flex; flex-direction:column; gap:10px}
    .sheet h3{margin:0; font-size:16px}
    .sheet .actions{display:flex; gap:8px; justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 헤더: 제목 + PIN 버튼 -->
    <div class="header">
      <div class="title">백산 이미지 업로더</div>
      <button id="pinBtn" type="button" class="pinbtn" title="공용 PIN 설정">🔒 PIN</button>
    </div>

    <div class="card">
      <!-- 수의사 버튼 그룹 + 보호자 이름(선택) 한 줄 -->
      <div class="row-inline">
        <div style="flex:1; min-width:150px">
          <label>수의사</label>
          <div id="vets" class="vets" role="listbox" aria-label="수의사 선택">
            <!-- ㄱㄴㄷ 순 버튼 -->
            <button class="vet" data-name="김지현">김지현</button>
            <button class="vet" data-name="김형준">김형준</button>
            <button class="vet" data-name="문정현">문정현</button>
            <button class="vet" data-name="민금주">민금주</button>
            <button class="vet" data-name="박소민">박소민</button>
            <button class="vet" data-name="송애라">송애라</button>
            <button class="vet" data-name="유수민">유수민</button>
            <button class="vet" data-name="이은지">이은지</button>
            <button class="vet" data-name="이소민">이소민</button>
            <button class="vet" data-name="정소연">정소연</button>
            <button class="vet" data-name="조문주">조문주</button>
            <button class="vet" data-name="한아름">한아름</button>
          </div>
        </div>
        <div class="owner">
          <label for="owner">보호자이름 (선택)</label>
          <input id="owner" placeholder="예: 김호두" />
        </div>
      </div>

      <!-- 환자(짧게) + 제목(넓게) -->
      <div class="row-pt-title">
        <div class="patient">
          <label for="patient">환자 *</label>
          <input id="patient" placeholder="예: 냥냥" maxlength="5"/>
        </div>
        <div class="titleinput">
          <label for="title">제목 *</label>
          <input id="title" placeholder="예: 간FNA" />
          <div class="hint">사용 안내: ① 수의사 선택 → ② 환자/제목 입력 → ③ 아래에서 사진 선택 후 “업로드”. 긴 변 2500px 초과 시 자동 축소. JPG/PNG만 지원.</div>
        </div>
      </div>

      <!-- 파일 + 툴바 -->
      <div>
        <label for="file">사진 선택</label>
        <input id="file" type="file" accept="image/*" multiple />
      </div>

      <div class="toolbar">
        <button id="uploadBtn" type="button" class="primary">📤 업로드</button>
        <button id="clearBtn" type="button" class="secondary">🧹 초기화</button>
      </div>

      <!-- 전체 진행률 -->
      <div class="progress"><div id="overallBar" class="bar"></div></div>
      <div class="sumline">
        <div id="overallText">대기 중</div>
        <div><b id="sumOk" style="color:var(--ok)">0 성공</b> · <b id="sumErr" style="color:var(--err)">0 실패</b></div>
      </div>

      <!-- 파일별 리스트 -->
      <div id="fileList" class="list"></div>
    </div>
  </div>

  <!-- PIN 모달 -->
  <div id="pinModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <h3>공용 PIN 입력</h3>
      <input id="pinInput" inputmode="numeric" pattern="\d*" placeholder="병원 공용 PIN 코드" autocomplete="one-time-code" />
      <div class="actions">
        <button id="pinCancel" class="secondary" type="button">취소</button>
        <button id="pinSave" class="primary" type="button">확인</button>
      </div>
    </div>
  </div>

  <script>
    // ------- 상태/공용 함수 -------
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const fmtBytes = n => n<1024? `${n} B` : n<1024**2? `${(n/1024).toFixed(1)} KB` : `${(n/1024**2).toFixed(1)} MB`;
    const todayYYYYMMDD = () => { const d=new Date(), p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}`; };

    let PIN = "";   // 상단 PIN 버튼으로 설정

    // ------- PIN 모달 -------
    const pinBtn = $('#pinBtn');
    const pinModal = $('#pinModal');
    const pinInput = $('#pinInput');
    $('#pinCancel').onclick = ()=> pinModal.classList.remove('show');
    $('#pinSave').onclick = ()=> {
      PIN = (pinInput.value || "").trim();
      pinModal.classList.remove('show');
      pinBtn.textContent = PIN ? '🔓 PIN' : '🔒 PIN';
      pinBtn.classList.toggle('locked', !!PIN);
    };
    pinBtn.onclick = ()=>{
      pinInput.value = PIN;
      pinModal.classList.add('show');
      pinInput.focus();
    };
    pinModal.addEventListener('click', (e)=>{ if(e.target===pinModal) pinModal.classList.remove('show'); });

    // ------- 수의사 버튼 그룹 -------
    let VET = "";
    $('#vets').addEventListener('click', (e)=>{
      const btn = e.target.closest('.vet');
      if(!btn) return;
      $$('#vets .vet').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      VET = btn.dataset.name;
    });

    // ------- 이미지 리사이즈 (Safari 호환, 2500 초과시에만) -------
    async function resizeIfNeeded(file){
      const isPNG = /png$/i.test(file.type);
      const isJPG = /jpe?g$/i.test(file.type);
      if(!isPNG && !isJPG) return file;

      const url = URL.createObjectURL(file);
      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = ()=>resolve(i);
        i.onerror = reject;
        i.src = url;
      });
      URL.revokeObjectURL(url);

      const max = 2500;
      const long = Math.max(img.naturalWidth, img.naturalHeight);
      if(long <= max) return file;

      const scale = max / long;
      const w = Math.round(img.naturalWidth*scale), h = Math.round(img.naturalHeight*scale);
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d', {alpha:false});
      ctx.drawImage(img,0,0,w,h);

      const mime = isPNG ? 'image/png' : 'image/jpeg';
      const quality = isPNG ? undefined : 0.9;

      const blob = await new Promise((resolve,reject)=>{
        canvas.toBlob(b => b?resolve(b):reject(new Error('toBlob failed')), mime, quality);
      });

      const ext = isPNG?'.png':'.jpg';
      const base = file.name.replace(/\.[a-z0-9]+$/i,'');
      return new File([blob], base+ext, {type:mime,lastModified:Date.now()});
    }

    // ------- 업로드(XHR 진행률) -------
    function xhrUpload(formData, onProgress){
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/upload', true);
        xhr.responseType = 'json';
        xhr.upload.onprogress = e => { if(e.lengthComputable && onProgress) onProgress(e.loaded / e.total); };
        xhr.onload = () => {
          const res = xhr.response ?? (()=>{ try{ return JSON.parse(xhr.responseText) } catch{ return {ok:false,error:xhr.responseText||xhr.statusText}; }})();
          resolve({ status: xhr.status, body: res });
        };
        xhr.onerror = () => reject(new Error('네트워크 오류'));
        xhr.send(formData);
      });
    }

    // ------- UI 엘리먼트 -------
    const overallBar = $('#overallBar');
    const overallText = $('#overallText');
    const list = $('#fileList');
    const btnUpload = $('#uploadBtn');
    const btnClear = $('#clearBtn');
    const sumOk = $('#sumOk'); const sumErr = $('#sumErr');

    function setDisabled(disabled){
      [btnUpload, $('#owner'), $('#patient'), $('#title'), $('#file')].forEach(el => el.disabled = disabled);
      $$('#vets .vet').forEach(el => el.disabled = disabled);
      pinBtn.disabled = disabled;
      btnUpload.textContent = disabled ? '⏳ 업로드 중…' : '📤 업로드';
    }
    function setOverall(p, text){ overallBar.style.width = `${Math.max(0,Math.min(100, p*100))}%`; overallText.textContent = text; }

    function addItemPreview(file){
      const url = URL.createObjectURL(file);
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `
        <div class="thumb"><img src="${url}" alt=""></div>
        <div class="meta">
          <div class="name">${file.name}</div>
          <div class="sub">${fmtBytes(file.size)}</div>
          <div class="progress" style="margin-top:6px"><div class="bar"></div></div>
        </div>
        <div class="pill up">대기</div>
      `;
      list.appendChild(el);
      const bar = el.querySelector('.bar');
      const pill = el.querySelector('.pill');
      return {
        setProgress: (r)=>{ bar.style.width = `${Math.round(r*100)}%`; },
        setStatus: (type, text)=>{ pill.className = `pill ${type}`; pill.textContent = text; },
        cleanup: ()=> URL.revokeObjectURL(url)
      };
    }

    btnClear.addEventListener('click', ()=>{
      list.innerHTML=''; setOverall(0,'대기 중'); sumOk.textContent='0 성공'; sumErr.textContent='0 실패';
      $('#file').value=''; // 입력값은 그대로 둠
    });

    btnUpload.addEventListener('click', async ()=>{
      const vet = VET;
      const owner = $('#owner').value.trim();
      const patient = $('#patient').value.trim();
      const title = $('#title').value.trim();
      const files = Array.from($('#file').files);

      if(!PIN) return alert('상단 PIN 버튼을 눌러 공용 PIN을 입력하세요');
      if(!vet) return alert('수의사를 선택하세요');
      if(!patient) return alert('환자이름은 필수입니다');
      if(!title) return alert('제목을 입력하세요');
      if(files.length===0) return alert('사진을 선택하세요');

      // UI 준비
      list.innerHTML='';
      setDisabled(true);
      setOverall(0,'준비 중…');
      let ok=0, err=0;
      const ymd = todayYYYYMMDD();

      // 순차 업로드
      for(let i=0;i<files.length;i++){
        const f = files[i];
        const ui = addItemPreview(f);
        ui.setStatus('up','준비 중');

        // 리사이즈
        let rf = f;
        try{
          rf = await resizeIfNeeded(f);
          ui.setStatus('up', rf!==f ? '리사이즈 완료' : '원본 유지');
        }catch(e){
          ui.setStatus('warn','리사이즈 실패, 원본');
          rf = f;
        }

        const hintName = `${patient}${owner?`_${owner}`:''}_${ymd}_${title}` + (rf.type==='image/png'?'.png':'.jpg');
        const form = new FormData();
        form.append('pin', PIN);
        form.append('vet', vet);
        form.append('patient', patient);
        form.append('owner', owner);
        form.append('title', title);
        form.append('file', rf, hintName);

        // 업로드
        ui.setStatus('up','업로드 중');
        try{
          const res = await xhrUpload(form, r=>{
            ui.setProgress(r);
            setOverall((i + r) / files.length, `전체 ${i+1}/${files.length} 업로드 중…`);
          });
          if(res.body && res.body.ok){
            ok++; ui.setProgress(1); ui.setStatus('ok','완료');
          }else{
            err++; ui.setStatus('err', res.body?.error || '실패');
          }
        }catch(e){
          err++; ui.setStatus('err', e.message || '네트워크 오류');
        }finally{
          ui.cleanup();
          sumOk.textContent = `${ok} 성공`;
          sumErr.textContent = `${err} 실패`;
        }
      }

      setDisabled(false);
      setOverall(1, err===0 ? '모든 업로드 완료' : `완료(성공 ${ok}, 실패 ${err})`);
      if(err===0){ $('#file').value=''; }
    });
  </script>
</body>
</html>
